inj
GFOR

%data

Rpr	            ! resistance of connection transformer (pu)
Lpr             ! inductance of connection transformer (pu)
r               ! ratio of ideal transformer
Snom            ! nominal apparent power (MVA)
H	            ! inertia constant (s)
D               ! damping constant of virtual synchronous machine model
Kp              ! proportional gain in active power control
Tpll            ! time constant of PLL (s)
R               ! droop of primary frequency control
Imax            ! maximum current (pu)
Kcs             ! gain in current saturation algorithm
Tcs             ! small time constant of current saturation (s)

%parameters

k={r}*sbase/{Snom}                                ! conversion factor of currents
vmx0= ([vx]/{r})+{Rpr}*[ix]*{k}-{Lpr}*[iy]*{k}    ! x component of initial modulated voltage (pu)
vmy0= ([vy]/{r})+{Rpr}*[iy]*{k}+{Lpr}*[ix]*{k}    ! y component of initial modulated voltage (pu)
Vmo=dsqrt({vmx0}**2 + {vmy0}**2)                  ! initial modulated voltage (pu)
Po=([vx]*[ix]+[vy]*[iy])*sbase/{Snom}             ! active power setpoint (pu on Snom base)

%states

wref=1.                                           ! angular speed of reference axes (pu)

ixt=[ix]*{k}                                      ! ix on converter side of transformer, in pu on Snom base 
iyt=[iy]*{k}                                      ! iy on converter side of transformer, in pu on Snom base
     
Vm={Vmo}                                          ! modulated voltage : magnitude
deltam=datan2({vmy0},{vmx0})                      ! modulated voltage : phase angle
V = dsqrt([vx]**2+[vy]**2)                        ! voltage at PCC

mult_pll = 1.		                              ! factor to freeze the PLL
w_pll = [wref]	                                  ! angular speed of PLL (= estimate of grid frequency)
delta_w_pll = 0.	                              ! angular speed deviation of PLL multiplied by hysteresis factor
theta_pll = atan2([vy],[vx])	                  ! phase angle of voltage estimated by PLL in rad
vq_pll= 0.                                        ! vq component of PLL multiplied by hysteresis factor

P={Po}                                            ! real active power produced (pu on Snom base)
Pvirt={Po}                                        ! virtual active power produced (pu on Snom base)
deltaP=0.                                         ! input of inertia integrator
omegam1=1.+{Kp}*{Po}                              ! output of inertia integrator
omegam=1.                                         ! rate of change of phase angle of modulated voltage
deltaomegam=0.                                    ! input of phase angle integrator

vmd={Vmo}                                         ! modulated voltage : d component
vmq=0.                                            ! modulated voltage : q component
vd= [vx]*cos([deltam])+[vy]*sin([deltam])         ! PCC voltage : d component
vq=-[vx]*sin([deltam])+[vy]*cos([deltam])         ! PCC voltage : q component
                                        
id= [ixt]*cos([deltam])+[iyt]*sin([deltam])       ! current : d component
iq=-[ixt]*sin([deltam])+[iyt]*cos([deltam])       ! current : q component
did_dt= 0                          
diq_dt= 0
id*=[id]                                          ! unsaturated setpoint of id
iq*=[iq]                                          ! unsaturated setpoint of iq
id*s=[id]                                         ! saturated setpoint of id
id*sdel=[id]                                      ! same with time constant
iq*s=[iq]                                         ! saturated setpoint of iq
iq*sdel=[iq]                                      ! same with time constant
I=dsqrt([id]**2+[iq]**2)                          ! current after CSA
I*=[I]                                            ! current before CSA
Irat={Imax}/max([I*],1.d-3)                       ! ratio Imax/I
Irats=1.                                          ! Irat limited to 1
f=1.                                              ! blocking factor

Q=([vq]/{r})*[id]-([vd]/{r})*[iq]                 ! reactive power produced (pu on Snom base)

%observables

P
Pvirt
Q
Vm
vmd
vmq
deltam
omegam
w_pll
I
id
id*
id*s
iq
iq*
iq*s

%models

& algeq                                                    ! computation of angular speed of reference axes (wref)
equalstr(omega_ref,'COI')*omega + equalstr(omega_ref,'SYN')-[wref]  

& algeq                                                    ! ix on converter side of ideal transformer, in pu on Snom base
[ixt]-[ix]*{k}                                   
& algeq                                                    ! iy on converter side of ideal transformer, in pu on Snom base
[iyt]-[iy]*{k}     

& algeq                                                    ! change of reference frame : vd(vx,vy)
 [vx]*cos([deltam])+[vy]*sin([deltam]) - [vd]
& algeq                                                    ! change of reference frame : vq(vx,vy)                                           
-[vx]*sin([deltam])+[vy]*cos([deltam]) - [vq]
& algeq                                                    ! change of reference frame : id(ixt,iyt)  
 [ixt]*cos([deltam])+[iyt]*sin([deltam]) - [id]
& algeq                                                    ! change of reference frame : iq(ixt,iyt)                                             
-[ixt]*sin([deltam])+[iyt]*cos([deltam]) - [iq]
& algeq                                                    ! magnitude of modulated voltage
dsqrt([vmd]**2+[vmq]**2) - [Vm]

& algeq                                        ! transformer : d component
(2.*pi*fnom/{Lpr})*([vmd] -([vd]/{r}) -{Rpr}*[id] +{Lpr}*[iq]) -[did_dt]
& int
did_dt
id
1.d0
& algeq                                        !             : q component
(2.*pi*fnom/{Lpr})*([vmq] -([vq]/{r}) -{Rpr}*[iq] -{Lpr}*[id]) -[diq_dt]
& int
diq_dt
iq
1.d0

& algeq                                        ! PLL: voltage at PCC (for blocking)
dsqrt([vx]**2+[vy]**2)-[V]
& hyst                                         !      hysteresis factor
V
mult_pll
0.5
0.
1.
0.4
1.
0.
1.
& algeq                                        !      angular speed deviation
(([w_pll]-[wref])*2*fnom*pi)*[mult_pll]-[delta_w_pll]
& algeq                                        !      vq component of PLL with hysteresis factor
([vy]*cos([theta_pll])-[vx]*sin([theta_pll]))*[mult_pll]-[vq_pll]
& pictl                                        !      PI controller						
vq_pll
w_pll
25/(2*fnom*pi*({Tpll})**2)
10/(2*fnom*pi*{Tpll})
& int                                          !      integrate to obtain theta_pll
delta_w_pll
theta_pll
1.d0

& pwlin4                                       !                 blocking factor of active power control
Irat
f
-1.
0.
1.
0.
1.
1.
2.
1.
& algeq                                        !                 computation of active power (pu on Snom base)
([vd]/{r})*[id]+([vq]/{r})*[iq]-[P]
& algeq                                        !                 computation of deltaP
({Po}-[P]-{D}*([omegam]-[w_pll])+(1.-[omegam])/{R})*[f]-[deltaP]
& int                                          !                 inertia integrator
deltaP
omegam1
2*{H}
& algeq                                        !                 computation of omegam
[omegam1]-{Kp}*[P]-[omegam]
& algeq                                        !                 computation of deltaomegam
(([omegam]-[wref])*2*pi*fnom)*[f]-[deltaomegam]
& int                                          !                 angle integrator
deltaomegam
deltam
1.

& algeq                                        ! current limiter - setpoint of id
({Vmo}-([vd]/{r})+{Lpr}*[iq]-{Rpr}*[id])/{Kcs} + [id] - [id*]
& algeq                                        !                 - setpoint of iq
(     -([vq]/{r})-{Lpr}*[id]-{Rpr}*[iq])/{Kcs} + [iq] - [iq*]
& algeq                                        !                 - current magnitude
dsqrt([id*]**2+[iq*]**2)-[I*]
& algeq                                        !                 - current ratio
{Imax}/max([I*],1.d-3)-[Irat]
& min1v1c                                      !                 - saturated current ratio
Irat
Irats
1.0
& algeq                                        !                 - saturated setpoint of id
[id*]*[Irats]-[id*s]
& tf1p                                         !                 - id*s with time constant
id*s
id*sdel
1.
{Tcs}
& algeq                                        !                 - saturated setpoint of iq
[iq*]*[Irats]-[iq*s]
& tf1p                                         !                 - iq*s with time constant
iq*s
iq*sdel
1.
{Tcs}
& algeq                                        !                 - control of id current
([vd]/{r})-{Lpr}*[iq]+{Rpr}*[id]+{Kcs}*([id*sdel]-[id]) - [vmd]
& algeq                                        !                 - control of iq current
([vq]/{r})+{Lpr}*[id]+{Rpr}*[iq]+{Kcs}*([iq*sdel]-[iq]) - [vmq]
& algeq                                        !                 - current in converteur
dsqrt([ixt]**2+[iyt]**2)-[I]

& algeq                                        ! observables - reactive power (pu on Snom base)
([vq]/{r})*[id]-([vd]/{r})*[iq]-[Q]
& algeq                                        !             - virtual active power (pu on Snom base)
([vd]/{r})*[id*]+([vq]/{r})*[iq*]-[Pvirt]